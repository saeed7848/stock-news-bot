import requests
import time
import logging
from config import TELEGRAM_TOKEN, CHAT_ID, NEWS_API

logging.basicConfig(level=logging.INFO)

# Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…
def send_message(text):
    url = f"https://api.telegram.org/bot{TELEGRAM_TOKEN}/sendMessage"
    data = {"chat_id": CHAT_ID, "text": text, "parse_mode": "HTML"}
    try:
        r = requests.post(url, data=data)
        if r.status_code != 200:
            logging.error(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: {r.text}")
    except Exception as e:
        logging.error(f"Ø§Ø³ØªØ«Ù†Ø§Ø¡ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: {e}")

# Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø®Ø¨Ø§Ø± Ù…Ù† NewsAPI ÙˆØªØ±Ø¬Ù…ØªÙ‡Ø§
def get_stock_news():
    try:
        r = requests.get(NEWS_API)
        articles = r.json().get("articles", [])
        news_list = []
        for a in articles[:3]:  # Ø¢Ø®Ø± 3 Ø£Ø®Ø¨Ø§Ø±
            title = a.get("title", "")
            url = a.get("url", "")
            source = a.get("source", {}).get("name", "")
            news_list.append(f"ğŸ“° <b>{title}</b>\nğŸ“Œ Ø§Ù„Ù…ØµØ¯Ø±: {source}\nğŸ”— {url}")
        return news_list
    except Exception as e:
        logging.error(f"Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø®Ø¨Ø§Ø±: {e}")
        return []

# Ø£Ø³Ù‡Ù… Ù…ØªØ­Ø±ÙƒØ© (Ø£Ù…Ø«Ù„Ø©ØŒ Ù…Ù…ÙƒÙ† ØªØ±Ø¨Ø·Ù‡Ø§ Ø¨Ù€ API Ø§Ù„Ø³ÙˆÙ‚)
def get_movers():
    movers = [
        {"symbol": "AAPL", "price": 180.5, "support": 178, "resistance": 182, "targets": [185, 190]},
        {"symbol": "TSLA", "price": 255.2, "support": 250, "resistance": 260, "targets": [270, 280]},
    ]
    alerts = []
    for stock in movers:
        text = (
            f"ğŸš€ <b>{stock['symbol']}</b>\n"
            f"ğŸ’µ Ø§Ù„Ø³Ø¹Ø±: {stock['price']}\n"
            f"ğŸ“‰ Ø§Ù„Ø¯Ø¹Ù…: {stock['support']}\n"
            f"ğŸ“ˆ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø©: {stock['resistance']}\n"
            f"ğŸ¯ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù: {', '.join(map(str, stock['targets']))}"
        )
        alerts.append(text)
    return alerts

# Ø§Ù„ØªØ´ØºÙŠÙ„
def main():
    sent_news = set()
    while True:
        # Ø£Ø®Ø¨Ø§Ø±
        news = get_stock_news()
        for n in news:
            if n not in sent_news:
                send_message(n)
                sent_news.add(n)

        # Ø£Ø³Ù‡Ù… Ù…ØªØ­Ø±ÙƒØ©
        movers_alerts = get_movers()
        for alert in movers_alerts:
            send_message(alert)

        time.sleep(300)  # ÙŠØ­Ø¯Ø« ÙƒÙ„ 5 Ø¯Ù‚Ø§ÙŠÙ‚

if _name_ == "_main_":
    main()
