# bot.py â€” Ø²Ø®Ù… + Ø®Ø¨Ø± Ù…ØªØ±Ø¬Ù… + Ù…Ø³ØªÙˆÙŠØ§Øª + Ø¥Ø±Ø³Ø§Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠ

import time
import requests
import yfinance as yf
import pandas as pd
import pandas_ta as ta
from googletrans import Translator
from datetime import datetime, timezone

# ================== Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ==================
TOKEN        = "ØªÙˆÙƒÙ†_Ø¨ÙˆØª_Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…"        # Ø¶Ø¹ Ø§Ù„ØªÙˆÙƒÙ† Ù‡Ù†Ø§
CHAT_ID      = "-100xxxxxxxxxxxx"          # Ø¢ÙŠ Ø¯ÙŠ Ø§Ù„Ù‚Ù†Ø§Ø© ÙŠØ¨Ø¯Ø£ Ø¨Ù€ -100
TICKERS      = ["AAPL", "TSLA", "NVDA"]    # Ø§Ù„Ø£Ø³Ù‡Ù… Ø§Ù„Ù…Ø±Ø§Ø¯ Ù…ØªØ§Ø¨Ø¹ØªÙ‡Ø§
NEWSAPI_KEY  = "Ù…ÙØªØ§Ø­_NewsAPI"             # Ù…ÙØªØ§Ø­ NewsAPI
INTERVAL_MIN = 5                           # ÙƒÙ„ ÙƒÙ… Ø¯Ù‚ÙŠÙ‚Ø© ÙŠØ¹ÙŠØ¯ Ø§Ù„ÙØ­Øµ
RSI_MIN      = 40
RSI_MAX      = 70
# ==============================================

TG_URL = f"https://api.telegram.org/bot{TOKEN}/sendMessage"
translator = Translator()

COMPANY_BY_SYMBOL = {
    "AAPL": "Apple",
    "TSLA": "Tesla",
    "NVDA": "NVIDIA",
    "MSFT": "Microsoft",
    "AMD": "Advanced Micro Devices",
    "AMZN": "Amazon",
    "META": "Meta",
    "GOOGL": "Alphabet",
    "NFLX": "Netflix",
}

# ====== Ø¥Ø±Ø³Ø§Ù„ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… ======
def send_message(text: str):
    try:
        requests.post(TG_URL, data={
            "chat_id": CHAT_ID,
            "text": text,
            "disable_web_page_preview": True
        }, timeout=15)
    except Exception as e:
        print("Telegram send error:", e)

# ====== Ø¬Ù„Ø¨ Ø®Ø¨Ø± Ù…ØªØ±Ø¬Ù… ======
def news_for_symbol(symbol: str):
    try:
        q = f'"{symbol}" OR "{COMPANY_BY_SYMBOL.get(symbol, symbol)}" stocks'
        url = "https://newsapi.org/v2/everything"
        params = {
            "q": q,
            "pageSize": 1,
            "sortBy": "publishedAt",
            "language": "en",
            "apiKey": NEWSAPI_KEY
        }
        r = requests.get(url, params=params, timeout=15)
        arts = (r.json() or {}).get("articles") or []
        if not arts:
            return None
        a = arts[0]
        title = a.get("title") or ""
        desc  = a.get("description") or ""
        link  = a.get("url") or ""
        src   = (a.get("source") or {}).get("name", "")

        # ØªØ±Ø¬Ù…
        try:
            title_ar = translator.translate(title, dest="ar").text if title else ""
            desc_ar  = translator.translate(desc,  dest="ar").text if desc else ""
        except Exception:
            title_ar, desc_ar = title, desc

        ts = ""
        if a.get("publishedAt"):
            try:
                dt = datetime.fromisoformat(a["publishedAt"].replace("Z","+00:00")).astimezone(timezone.utc)
                ts = dt.strftime("%Y-%m-%d %H:%M UTC")
            except Exception:
                pass

        block = f"ğŸ“° Ø®Ø¨Ø± Ù…ØªØ¹Ù„Ù‚ Ø¨Ù€ {symbol}\nØ§Ù„Ø¹Ù†ÙˆØ§Ù†: {title_ar}"
        if desc_ar: block += f"\nØ§Ù„ØªÙØ§ØµÙŠÙ„: {desc_ar}"
        if ts:      block += f"\nğŸ“… Ø§Ù„ÙˆÙ‚Øª: {ts}"
        if link:    block += f"\nğŸ”— {link}"
        if src:     block += f"\nğŸ“Œ Ø§Ù„Ù…ØµØ¯Ø±: {src}"
        return block
    except Exception as e:
        print("news error:", e)
        return None

# ====== ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³Ù‡Ù… ======
def analyze_stock(symbol: str):
    try:
        tk = yf.Ticker(symbol)

        # Ø¥Ø·Ø§Ø± 15 Ø¯Ù‚ÙŠÙ‚Ø© Ù„Ù„Ø²Ø®Ù…
        df = tk.history(period="7d", interval="15m", auto_adjust=False)
        if df.empty or len(df) < 50:
            return None
        price = float(df["Close"].iloc[-1])

        rsi = ta.rsi(df["Close"], length=14).iloc[-1]
        if pd.isna(rsi):
            return None
        if not (RSI_MIN <= float(rsi) <= RSI_MAX):
            return None

        # Ø¥Ø·Ø§Ø± ÙŠÙˆÙ…ÙŠ Ù„Ù„Ø¯Ø¹Ù…/Ø§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø©
        dfd = tk.history(period="7d", interval="1d", auto_adjust=False)
        if dfd.empty:
            return None
        resistance = float(dfd["High"].max())
        support    = float(dfd["Low"].min())

        # Ø£Ù‡Ø¯Ø§Ù ÙˆÙˆÙ‚Ù
        target1 = round(price * 1.05, 2)
        target2 = round(price * 1.10, 2)
        stop    = round(support, 2)

        # Ø®Ø¨Ø±
        news_block = news_for_symbol(symbol)

        # ØµÙŠØ§ØºØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø©
        lines = [
            f"ğŸš€ Ø³Ù‡Ù…: {symbol}",
            f"ğŸ’µ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¢Ù†: {round(price,2)}",
            f"ğŸ“ˆ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø©: {round(resistance,2)}",
            f"ğŸ“‰ Ø§Ù„Ø¯Ø¹Ù… (ÙˆÙ‚Ù): {round(support,2)}",
            f"ğŸ¯ Ø§Ù„Ù‡Ø¯Ù 1: {target1}",
            f"ğŸ¯ Ø§Ù„Ù‡Ø¯Ù 2: {target2}",
            f"ğŸ“Š RSI(14): {round(float(rsi),2)} Ø¶Ù…Ù† {RSI_MIN}-{RSI_MAX}",
        ]
        if news_block:
            lines += ["â€”", news_block]

        return "\n".join(lines)

    except Exception as e:
        print("analyze error:", symbol, e)
        return None

# ====== Ø¯ÙˆØ±Ø© ÙˆØ§Ø­Ø¯Ø© ======
def run_once():
    found = False
    for sym in TICKERS:
        msg = analyze_stock(sym)
        if msg:
            send_message(msg)
            found = True
    if not found:
        send_message(f"â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ù‡Ù… ØªØ­Ù‚Ù‚ RSI Ø¨ÙŠÙ† {RSI_MIN}-{RSI_MAX} Ø­Ø§Ù„ÙŠØ§Ù‹.")

# ====== Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ======
def main():
    send_message("âœ… Ø§Ù„Ø¨ÙˆØª Ø¨Ø¯Ø£ Ø§Ù„Ø¹Ù…Ù„ (Ø²Ø®Ù… + Ø®Ø¨Ø± Ù…ØªØ±Ø¬Ù… + Ù…Ø³ØªÙˆÙŠØ§Øª)")
    while True:
        run_once()
        time.sleep(INTERVAL_MIN * 60)

if __name__ == "__main__":
    main()