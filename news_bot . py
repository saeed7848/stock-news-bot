import time
import requests
import yfinance as yf
import pandas as pd
import pandas_ta as ta
from googletrans import Translator
from datetime import datetime, timezone

from config import TOKEN, CHAT_ID, TICKERS, NEWSAPI_KEY, INTERVAL_MIN, RSI_MIN, RSI_MAX

TG_URL = f"https://api.telegram.org/bot{TOKEN}/sendMessage"
translator = Translator()

COMPANY_BY_SYMBOL = {
    "AAPL": "Apple", "TSLA": "Tesla", "NVDA": "NVIDIA",
    "MSFT": "Microsoft", "AMD": "Advanced Micro Devices",
}

def send_message(text: str):
    try:
        requests.post(TG_URL, data={"chat_id": CHAT_ID, "text": text})
    except Exception as e:
        print("Telegram send error:", e)

def news_for_symbol(symbol: str):
    try:
        q = f'"{symbol}" OR "{COMPANY_BY_SYMBOL.get(symbol, symbol)}" stocks'
        url = "https://newsapi.org/v2/everything"
        params = {
            "q": q, "pageSize": 1, "sortBy": "publishedAt",
            "language": "en", "apiKey": NEWSAPI_KEY
        }
        r = requests.get(url, params=params, timeout=15)
        arts = (r.json() or {}).get("articles") or []
        if not arts: return None
        a = arts[0]
        title = a.get("title") or ""
        desc  = a.get("description") or ""
        link  = a.get("url") or ""
        src   = (a.get("source") or {}).get("name", "")

        # ØªØ±Ø¬Ù…
        try:
            title_ar = translator.translate(title, dest="ar").text if title else ""
            desc_ar  = translator.translate(desc,  dest="ar").text if desc  else ""
        except Exception:
            title_ar, desc_ar = title, desc

        ts = ""
        if a.get("publishedAt"):
            try:
                dt = datetime.fromisoformat(a["publishedAt"].replace("Z","+00:00")).astimezone(timezone.utc)
                ts = dt.strftime("%Y-%m-%d %H:%M UTC")
            except Exception:
                pass

        block = f"ğŸ“° Ø®Ø¨Ø± Ù…ØªØ¹Ù„Ù‚ Ø¨Ù€ {symbol}\nØ§Ù„Ø¹Ù†ÙˆØ§Ù†: {title_ar}"
        if desc_ar: block += f"\nØ§Ù„ØªÙØ§ØµÙŠÙ„: {desc_ar}"
        if ts:      block += f"\nğŸ“… Ø§Ù„ÙˆÙ‚Øª: {ts}"
        if link:    block += f"\nğŸ”— {link}"
        if src:     block += f"\nğŸ“Œ Ø§Ù„Ù…ØµØ¯Ø±: {src}"
        return block
    except Exception as e:
        print("news error:", e)
        return None

def analyze_stock(symbol: str):
    try:
        tk  = yf.Ticker(symbol)
        # Ø¥Ø·Ø§Ø± 15Ù… Ù„Ù‚ÙŠØ§Ø³ RSI Ø£Ø³Ø¨ÙˆØ¹ÙŠØ§Ù‹ (Ø²Ø®Ù…)
        df  = tk.history(period="7d", interval="15m", auto_adjust=False)
        if df.empty or len(df) < 50: return None
        price = float(df["Close"].iloc[-1])

        rsi = ta.rsi(df["Close"], length=14).iloc[-1]
        if pd.isna(rsi): return None
        if not (RSI_MIN <= float(rsi) <= RSI_MAX): return None

        # Ø¯Ø¹Ù…/Ù…Ù‚Ø§ÙˆÙ…Ø© Ù…Ù† Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù… ÙŠÙˆÙ…ÙŠØ©
        dfd = tk.history(period="7d", interval="1d", auto_adjust=False)
        if dfd.empty: return None
        resistance = float(dfd["High"].max())
        support    = float(dfd["Low"].min())

        target1 = round(price * 1.05, 2)
        target2 = round(price * 1.10, 2)
        stop    = round(support, 2)

        news_block = news_for_symbol(symbol)  # Ù‚Ø¯ ØªÙƒÙˆÙ† None

        lines = [
            f"ğŸš€ Ø³Ù‡Ù…: {symbol}",
            f"ğŸ’µ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¢Ù†: {round(price,2)}",
            f"ğŸ“ˆ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø©: {round(resistance,2)}",
            f"ğŸ“‰ Ø§Ù„Ø¯Ø¹Ù… (ÙˆÙ‚Ù): {round(support,2)}",
            f"ğŸ¯ Ø§Ù„Ù‡Ø¯Ù 1: {target1}",
            f"ğŸ¯ Ø§Ù„Ù‡Ø¯Ù 2: {target2}",
            f"ğŸ“Š RSI(14): {round(float(rsi),2)} Ø¶Ù…Ù† {RSI_MIN}-{RSI_MAX}",
        ]
        if news_block:
            lines += ["â€”", news_block]
        return "\n".join(lines)
    except Exception as e:
        print("analyze error:", symbol, e)
        return None

def run_once():
    found = False
    for sym in TICKERS:
        msg = analyze_stock(sym)
        if msg:
            send_message(msg); found = True
    if not found:
        send_message(f"â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ù‡Ù… ØªØ­Ù‚Ù‚ RSI Ø¨ÙŠÙ† {RSI_MIN}-{RSI_MAX} Ø­Ø§Ù„ÙŠØ§Ù‹.")

def main():
    send_message("âœ… Ø§Ù„Ø¨ÙˆØª Ø¨Ø¯Ø£ Ø§Ù„Ø¹Ù…Ù„ (Ø²Ø®Ù… + Ø®Ø¨Ø± + Ù…Ø³ØªÙˆÙŠØ§Øª)")
    while True:
        run_once()
        time.sleep(int(INTERVAL_MIN) * 60)

if __name__ == "__main__":
    main()